<p-toast></p-toast>
<div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-6xl mx-auto">
    <h1
      class="title-font sm:text-4xl text-3xl mb-4 font-medium text-gray-900 text-center"
    >
      Nueva Factura
    </h1>
    <p class="mt-1 text-sm text-gray-500 text-center">
      Completa toda la información para crear una nueva Factura.
    </p>

    <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-0 sm:grid-cols-6">
      <div class="sm:col-span-3">
        <label class="block text-md font-medium text-gray-700" for="clientId">
          Cliente
        </label>
        <div class="relative mt-1">
          <p-autoComplete
            styleClass="w-full rounded-l-md"
            [(ngModel)]="client"
            [suggestions]="filteredClients"
            (completeMethod)="filterClient($event)"
            (ngModelChange)="newInvoice.ClientId = $event.id"
            field="fullName"
            name="fullName"
            [dropdown]="true"
          >
            <ng-template let-client pTemplate="item">
              <div class="client-item">
                <div>{{ client.fullName }}</div>
              </div>
            </ng-template>
          </p-autoComplete>
        </div>
      </div>
      <div class="sm:col-span-1">
        <div class="mt-4 sm:mt-6">
          <button
            (click)="opencloseModal()"
            pRipple
            class="inline-flex items-center justify-center sm:w-auto px-3 py-3 rounded-r-md mt-1 border border-transparent bg-indigo-600 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            type="button"
          >
            <div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4v16m8-8H4"
                />
              </svg>
            </div>
          </button>
        </div>
      </div>
      <div class="sm:col-span-2">
        <label class="block text-md mb-1 font-medium text-gray-700" for="number"
          >Número de Factura</label
        >
        <input
          class="w-full"
          id="number"
          type="text"
          aria-describedby="invoice-number"
          pInputText
          [(ngModel)]="newInvoice.number"
        />
      </div>
    </div>
    <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
      <div class="sm:col-span-3">
        <label
          class="block text-md font-medium text-gray-700"
          for="invoice_date"
        >
          Fecha</label
        >
        <div class="mt-1">
          <p-calendar
            inputId="date"
            [(ngModel)]="newInvoice.date"
            [defaultDate]="today"
            dateFormat="dd/mm/yy"
            name="date"
            autocomplete="date"
            styleClass="w-full"
            inputStyleClass="shadow-sm block w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          ></p-calendar>
        </div>
      </div>
      <div class="sm:col-span-3">
        <label class="block text-md font-medium text-gray-700" for="due-date">
          Fecha Vencimiento
        </label>
        <div class="mt-1">
          <p-calendar
            inputId="dueDate"
            [(ngModel)]="newInvoice.dueDate"
            dateFormat="dd/mm/yy"
            name="dueDate"
            autocomplete="dueDate"
            styleClass="w-full"
            inputStyleClass="shadow-sm block w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          ></p-calendar>
        </div>
      </div>
      <div class="sm:col-span-3">
        <div class="mt-1">
          <div class="flex items-center">
            <label
              class="mr-3 block text-md font-medium text-gray-700"
              for="isRecurrent"
              >¿Es Recurrente?</label
            >
            <p-toggleButton
              [(ngModel)]="newInvoice.isRecurrent"
              onIcon="pi pi-check"
              offIcon="pi pi-times"
              iconPos="right"
            ></p-toggleButton>
          </div>
        </div>
      </div>
    </div>

    <div class="pt-8">
      <div class="sm:flex sm:items-center mb-10">
        <div class="sm:flex-auto">
          <h1 class="text-xl text-center font-semibold text-gray-900">
            Ítems a Facturar
          </h1>
        </div>
        <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
          <button
            class="inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:w-auto"
            type="button"
            (click)="clicked = true"
          >
            Crear Nuevo Ítem
          </button>
        </div>
      </div>
      <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div
            class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8"
          >
            <div
              class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg"
            >
              <p-table
                #dt
                [value]="products"
                [rows]="10"
                [paginator]="false"
                [rowHover]="true"
                dataKey="id"
                [showCurrentPageReport]="true"
                editMode="row"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th *ngFor="let col of cols">
                      {{ col.header }}
                    </th>
                    <th></th>
                  </tr>
                </ng-template>
                <ng-template
                  pTemplate="body"
                  let-product
                  let-editing="editing"
                  let-ri="rowIndex"
                >
                  <tr [pEditableRow]="product">
                    <td pEditableColumn>
                      <p-cellEditor>
                        <ng-template pTemplate="input">
                          <p-autoComplete
                            styleClass="w-full"
                            [(ngModel)]="product.item"
                            [suggestions]="filteredItems"
                            (completeMethod)="filterItem($event)"
                            (onSelect)="calculateInvoiceTotal(products)"
                            (ngModelChange)="newInvoice.items.push($event)"
                            field="name"
                            name="name"
                            [dropdown]="true"
                          >
                            <ng-template let-item pTemplate="item">
                              {{ item.name }}
                            </ng-template>
                          </p-autoComplete>
                        </ng-template>
                        <ng-template pTemplate="output">
                          {{ product.item.name }}
                        </ng-template>
                      </p-cellEditor>
                    </td>
                    <td pEditableColumn>
                      <p-cellEditor>
                        <ng-template pTemplate="input">
                          <p-inputNumber
                            [size]="1"
                            [(ngModel)]="product.item.quantity"
                            (ngModelChange)="
                              product.item.total =
                                $event *
                                product.item.cost *
                                (1 + product.item.tax1 / 100);
                              product.item.subtotal = $event * product.item.cost
                            "
                            [min]="1"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            decrementButtonClass="ui-button-success"
                            incrementButtonClass="ui-button-success"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus"
                            value="number"
                            name="quantity"
                            title="quantity"
                            mode="decimal"
                            [allowEmpty]="false"
                            (onInput)="calculateInvoiceTotal(products)"
                          ></p-inputNumber>
                        </ng-template>
                        <ng-template pTemplate="output">
                          {{ product.item.quantity }}
                        </ng-template>
                      </p-cellEditor>
                    </td>
                    <td pEditableColumn>
                      {{ product.item.cost | currency: "EUR" }}
                    </td>
                    <td pEditableColumn>{{ product.item.tax1 }}</td>
                    <td pEditableColumn>
                      {{ product.item.total | currency: "EUR" }}
                    </td>
                    <td style="text-align: center">
                      <button
                        *ngIf="!editing"
                        pButton
                        pRipple
                        type="button"
                        pInitEditableRow
                        icon="pi pi-pencil"
                        class="up-button-rounded p-button-text"
                        (click)="onRowEditInit(product)"
                      ></button>
                      <button
                        [disabled]="clicked"
                        *ngIf="!editing"
                        pButton
                        pRipple
                        type="button"
                        icon="pi pi-plus"
                        class="up-button-rounded p-button-text"
                        (click)="onAddItemRow(); clicked = true"
                      ></button>
                      <button
                        *ngIf="editing"
                        pButton
                        pRipple
                        type="button"
                        pSaveEditableRow
                        icon="pi pi-check"
                        class="p-button-rounded p-button-text p-button-success p-mr-2"
                        style="margin-right: 0.5em"
                        (click)="onRowEditSave(product, ri); clicked = false"
                      ></button>
                      <button
                        *ngIf="editing"
                        pButton
                        pRipple
                        type="button"
                        pCancelEditableRow
                        icon="pi pi-times"
                        class="p-button-rounded p-button-text p-button-danger"
                        (click)="onRowEditCancel(product, ri); clicked = false"
                      ></button>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage" let-columns>
                  <tr>
                    <td [attr.colspan]="cols.length">
                      Por favor, agrega un ítem para facturar
                    </td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="summary">
                  <div class="text-right">
                    Subtotal: {{ newInvoice.subtotal | currency: "EUR" }}
                  </div>
                  <div class="text-right">
                    IVA: {{ newInvoice.taxAmount | currency: "EUR" }}
                  </div>
                  <div class="text-right">
                    Total Factura: {{ newInvoice.total | currency: "EUR" }}
                  </div>
                  <div class="p-d-flex p-ai-center p-jc-between">
                    Tienes
                    {{ products ? products.length : 0 }}
                    {{ products.length < 2 ? "Ítem." : "Ítems." }}
                  </div>
                </ng-template>
              </p-table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="pt-8">
      <div class="sm:col-span-6">
        <label class="block text-md font-medium text-gray-700" for="notes">
          Notas
          <div class="mt-1">
            <textarea
              pInputTextarea
              [(ngModel)]="newInvoice.notes"
              name="notes"
              [rows]="3"
              class="shadow-sm block w-full border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            ></textarea>
            <p class="mt-2 text-sm text-gray-500">
              Condiciones de venta o alguna observación.
            </p>
          </div></label
        >
      </div>
    </div>
    <div class="pt-5">
      <div class="flex justify-end">
        <a routerLink="/invoices"
          ><button
            class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-lg font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            type="button"
          >
            Cancelar
          </button></a
        ><button
          class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-lg font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          type="submit"
          (click)="saveNewInvoice()"
        >
          Crear
        </button>
      </div>
    </div>
    <ul>
      <!-- <li>client: {{ client | json }}</li>
      <li>newInvoice.client: {{ newInvoice.Client.fullName | json }}</li>
      <li>newInvoice.date: {{ newInvoice.date }}</li>
      <li>newInvoice.dueDate: {{ newInvoice.dueDate }}</li>
      <li>newInvoice.isRecurrent: {{ newInvoice.isRecurrent }}</li>
      <li>newInvoice.notes: {{ newInvoice.notes }}</li> -->
      <li>products: {{ products | json }}</li>
      <li>newInvoice: {{ newInvoice | json }}</li>
    </ul>
    <p>lastInvoice: {{ lastInvoice | json }}</p>
  </div>
</div>
<div
  class="relative z-10"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
  [ngClass]="{
    'ease-in duration-500 opacity-0 -z-20': !modalToggle,
    'z-10': modalToggle
  }"
>
  <div
    class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
    [ngClass]="{
      'ease-in duration-200 opacity-0': !modalToggle,
      'ease-out duration-300 opacity-100': modalToggle
    }"
  ></div>
  <div class="fixed z-10 inset-0 overflow-y-auto">
    <div
      class="flex items-end sm:items-center justify-center min-h-full p-1 text-center sm:p-0"
    >
      <div
        [ngClass]="{
          'transition ease-in duration-75 transform opacity-0 scale-95':
            !modalToggle,
          'transition ease-out duration-100 transform opacity-100 scale-100':
            modalToggle
        }"
        class="relative bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-3xl sm:w-full sm:p-6"
      >
        <div>
          <div class="mt-1 sm:mt-1">
            <app-client-add></app-client-add>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
